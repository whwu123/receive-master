<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>菜鸟教程(runoob.com)</title>

    <script type="text/javascript">

        var ws = null;
        var interval = null;
        var uri = "ws://127.0.0.1:9999/ws";
        var myVar = null;
        var reconnectState = null;

        function WebSocketTest(){
            if ("WebSocket" in window){
                createWebSocket();
            }else{
                // 浏览器不支持 WebSocket
                alert("您的浏览器不支持 WebSocket!");
            }
        }

        /**
         * 创建websocket
         */
        function createWebSocket() {
            alert("开启长连接")
            // 打开一个 web socket
            ws = new WebSocket(uri);
            ws.onopen = function(){
                document.getElementById("reconnectShow").innerText= "无";
                document.getElementById("online").innerText= "在线";
                reconnectState = false;
                clearInterval(myVar);
                // 心跳检测
                interval = setInterval(function () {
                    // 使用 send() 方法发送数据
                    sendMsg("ping");
                }, 5000);

            };

            ws.onmessage = function (evt){
                var received_msg = evt.data;
                if(received_msg == "pong"){
                    console.log(received_msg);
                }else{
                    document.getElementById("num").innerText= received_msg;
                }
            };

            ws.onclose = function(){
                webscoketClose();
            };
        }


        /**
         * websocket重连
         */
        function reconnect() {
            // 检测到websocket连接断开
            // 0 (WebSocket.CONNECTING)正在链接中
            // 1 (WebSocket.OPEN)已经链接并且可以通讯
            // 2 (WebSocket.CLOSING) 连接正在关闭
            // 3 (WebSocket.CLOSED)连接已关闭或者没有链接成功
            if(reconnectState == false){
                reconnectState = true;
                var reconnectNum = 1;
                console.log(ws.readyState);
                myVar = setInterval(function(){
                    if(ws.readyState == 2 || ws.readyState == 3){
                        if(reconnectNum == 6){
                            clearInterval(myVar);
                            document.getElementById("reconnectShow").innerText= "停止重连";
                            return;
                        }
                        document.getElementById("reconnectShow").innerText= "第" + reconnectNum + "次尝试重连中";
                        createWebSocket();
                        reconnectNum ++;
                    }

                },5*1000)
            }
        }

        function noReconnectclose() {
            reconnectState = true;
            webscoketClose();
        }

        /**
         * websocket关闭
         */
        function webscoketClose() {
            ws.close();
            clearInterval(interval)
            console.log("websocket关闭");
            document.getElementById("online").innerText= "离线";
            // 开启断线重连
            reconnect();
        }

        function sendMsg(str){
            if(ws.readyState == 1){
                ws.send(str);
            }else{
                alert("未连接上服务器");
            }
        }

        function add() {
            sendMsg("+1");
        }

        function remove() {
            sendMsg("-1");
        }

    </script>

</head>
<body>
<div id="sse">
    <a href="javascript:WebSocketTest()">运行 WebSocket</a>
    <a href="javascript:noReconnectclose()">停止 WebSocket</a>
</div>
<br>
当前webscoket状态：<span id="online">离线</span>
<br>
当前重连状态：<span id="reconnectShow">无</span>
<br>
当前怒气值：<span id="num">0</span>
<br>
<a href="javascript:add()">+1</a>
<a href="javascript:remove()">-1</a>
</body>
</html>
